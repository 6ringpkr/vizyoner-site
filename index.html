<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Morph Messaging</title>
    <meta name="description" content="Real-time Morph Messaging with MQTT integration">
    <meta name="theme-color" content="#2563EB">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Morph Messaging">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest.json">
    <!-- Apple Touch Icons using your existing iOS icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/ios/180.png">
    <link rel="apple-touch-icon" sizes="167x167" href="/icons/ios/167.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/icons/ios/152.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/icons/ios/144.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/icons/ios/120.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/icons/ios/114.png">
    <link rel="apple-touch-icon" sizes="100x100" href="/icons/ios/100.png">
    <link rel="apple-touch-icon" sizes="87x87" href="/icons/ios/87.png">
    <link rel="apple-touch-icon" sizes="80x80" href="/icons/ios/80.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/icons/ios/76.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/icons/ios/72.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/icons/ios/60.png">
    <link rel="apple-touch-icon" sizes="58x58" href="/icons/ios/58.png">
    <link rel="apple-touch-icon" sizes="57x57" href="/icons/ios/57.png">
    <link rel="apple-touch-icon" href="/icons/ios/180.png">
    
    <!-- iOS Status Bar and Viewport -->
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    
    <!-- Windows Metro Tile Colors -->
    <meta name="msapplication-TileColor" content="#2563EB">
    <meta name="msapplication-TileImage" content="/icons/windows11/Square150x150Logo.scale-200.png">
    <meta name="msapplication-config" content="/browserconfig.xml">
    
    <!-- Standard Favicons -->
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/ios/32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/ios/16.png">
    <link rel="shortcut icon" href="/icons/ios/32.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Material Design Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', 'system-ui', 'sans-serif'],
                    },
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        /* Custom animations and overrides */
        .slide-up {
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .fade-in {
            animation: fadeIn 0.4s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .pulse-dot {
            animation: pulseDot 2s infinite;
        }
        
        @keyframes pulseDot {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }
        
        /* PWA title bar */
        @media (display-mode: window-controls-overlay) {
            body {
                padding-top: env(titlebar-area-height);
            }
            
            .titlebar {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                height: env(titlebar-area-height);
                background: #2563eb;
                display: flex;
                align-items: center;
                padding: 0 16px;
                z-index: 1000;
                -webkit-app-region: drag;
                color: white;
                font-size: 14px;
                font-weight: 500;
            }
        }
        
        /* Touch-friendly improvements */
        .touch-target {
            min-height: 44px;
            min-width: 44px;
        }
        
        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }
        
        /* Custom scrollbar for webkit browsers */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <!-- PWA Title Bar -->
    <div class="titlebar hidden">
        <span class="material-icons mr-2">notifications</span>
        Morph Messaging
    </div>
    
    <!-- Install Banner -->
    <div id="installBanner" class="hidden bg-gradient-to-r from-blue-600 to-blue-700 text-white p-4 relative slide-up">
        <div class="flex items-center justify-between max-w-4xl mx-auto">
            <div class="flex items-center space-x-3">
                <span class="material-icons">get_app</span>
                <div>
                    <p class="font-medium">Install App</p>
                    <p class="text-blue-100 text-sm">Get the best experience with our PWA!</p>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <button id="installButton" class="bg-white/20 hover:bg-white/30 backdrop-blur border border-white/30 text-white px-4 py-2 rounded-lg font-medium transition-all duration-200 touch-target">
                    Install
                </button>
                <button id="dismissBanner" class="p-3 hover:bg-white/20 rounded-full transition-colors touch-target">
                    <span class="material-icons">close</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Header -->
    <header class="bg-white shadow-sm border-b sticky top-0 z-40">
        <div class="max-w-4xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center">
                        <span class="material-icons text-white text-xl">notifications</span>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold text-gray-900">Morph Messaging</h1>
                        <p class="text-sm text-gray-500 hidden sm:block">Real-time MQTT notifications</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="flex items-center space-x-2 bg-gray-50 px-3 py-2 rounded-lg">
                        <div id="mqttStatusDot" class="w-3 h-3 bg-red-500 rounded-full pulse-dot"></div>
                        <span id="mqttStatusText" class="text-sm font-medium text-gray-700">Disconnected</span>
                    </div>
                </div>
            </div>
        </div>
    </header>
    
    <!-- Navigation -->
    <nav class="bg-white border-b sticky top-16 z-30">
        <div class="max-w-4xl mx-auto">
            <div class="flex overflow-x-auto scrollbar-hide">
                <button class="nav-btn flex items-center space-x-2 px-4 py-3 text-blue-600 border-b-2 border-blue-600 whitespace-nowrap touch-target" data-page="live">
                    <span class="material-icons text-lg">wifi_tethering</span>
                    <span class="font-medium">Live</span>
                </button>
                <button class="nav-btn flex items-center space-x-2 px-4 py-3 text-gray-600 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-200 whitespace-nowrap touch-target" data-page="history">
                    <span class="material-icons text-lg">history</span>
                    <span class="font-medium">History</span>
                </button>
                <button class="nav-btn flex items-center space-x-2 px-4 py-3 text-gray-600 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-200 whitespace-nowrap touch-target" data-page="config">
                    <span class="material-icons text-lg">settings</span>
                    <span class="font-medium">Config</span>
                </button>
                <button class="nav-btn flex items-center space-x-2 px-4 py-3 text-gray-600 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-200 whitespace-nowrap touch-target" data-page="about">
                    <span class="material-icons text-lg">info</span>
                    <span class="font-medium">About</span>
                </button>
            </div>
        </div>
    </nav>
    
    <!-- Status Bar -->
    <div class="bg-white mx-4 mt-4 rounded-xl shadow-sm border p-4">
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="text-center">
                <div class="flex items-center justify-center space-x-2 mb-1">
                    <div id="connectionStatusDot" class="w-3 h-3 bg-red-500 rounded-full pulse-dot"></div>
                    <span class="text-sm font-medium text-gray-600">Connection</span>
                </div>
                <p id="connectionStatus" class="text-lg font-bold text-gray-900">Disconnected</p>
            </div>
            <div class="text-center">
                <div class="flex items-center justify-center space-x-2 mb-1">
                    <span class="material-icons text-gray-500 text-sm">notifications</span>
                    <span class="text-sm font-medium text-gray-600">Total</span>
                </div>
                <p id="totalNotifications" class="text-lg font-bold text-blue-600">0</p>
            </div>
            <div class="text-center">
                <div class="flex items-center justify-center space-x-2 mb-1">
                    <span class="material-icons text-gray-500 text-sm">pending</span>
                    <span class="text-sm font-medium text-gray-600">Pending</span>
                </div>
                <p id="pendingCount" class="text-lg font-bold text-orange-600">0</p>
            </div>
            <div class="text-center">
                <div class="flex items-center justify-center space-x-2 mb-1">
                    <span class="material-icons text-gray-500 text-sm">access_time</span>
                    <span class="text-sm font-medium text-gray-600">Updated</span>
                </div>
                <p id="lastUpdated" class="text-sm font-medium text-gray-700">Never</p>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <main class="max-w-4xl mx-auto px-4 pb-6">
        <!-- Live Notifications Page -->
        <div id="livePage" class="page active mt-6">
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-2">Live Notifications</h2>
                <p class="text-gray-600">Real-time job order notifications from MQTT broker</p>
            </div>
            <div id="liveNotifications" class="space-y-4">
                <div class="text-center py-12">
                    <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <span class="material-icons text-gray-400 text-3xl">wifi_tethering</span>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">No notifications yet</h3>
                    <p class="text-gray-500">Waiting for incoming notifications from the MQTT broker...</p>
                </div>
            </div>
        </div>
        
        <!-- History Page -->
        <div id="historyPage" class="page hidden mt-6">
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-2">Notification History</h2>
                <p class="text-gray-600">Browse and search through past notifications</p>
            </div>
            
            <!-- Search and Filter -->
            <div class="bg-white rounded-xl shadow-sm border p-4 mb-6">
                <div class="flex flex-col sm:flex-row gap-4">
                    <div class="flex-1">
                        <div class="relative">
                            <span class="material-icons absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">search</span>
                            <input id="searchInput" type="text" placeholder="Search notifications..." 
                                class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>
                    <div class="sm:w-48">
                        <select id="statusFilter" class="w-full py-3 px-4 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div id="historyNotifications" class="space-y-4">
                <div class="text-center py-12">
                    <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <span class="material-icons text-gray-400 text-3xl">history</span>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">No history yet</h3>
                    <p class="text-gray-500">Notification history will appear here once you start receiving notifications</p>
                </div>
            </div>
        </div>
        
        <!-- Configuration Page -->
        <div id="configPage" class="page hidden mt-6">
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-2">MQTT Configuration</h2>
                <p class="text-gray-600">Configure your MQTT broker connection settings</p>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">MQTT Broker URL</label>
                        <input id="mqttBroker" type="text" placeholder="wss://broker.emqx.io:8084/mqtt" 
                            class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Topic</label>
                        <input id="mqttTopic" type="text" placeholder="notifications/joborders" 
                            class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Client ID</label>
                        <input id="mqttClientId" type="text" placeholder="notification-viewer-001" 
                            class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Response Topic</label>
                        <input id="mqttResponseTopic" type="text" placeholder="responses/joborders" 
                            class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Username (Optional)</label>
                        <input id="mqttUsername" type="text" placeholder="username" 
                            class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password (Optional)</label>
                        <input id="mqttPassword" type="password" placeholder="password" 
                            class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>
                <button onclick="saveMqttConfig()" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors flex items-center justify-center space-x-2 touch-target">
                    <span class="material-icons">save</span>
                    <span>Save & Connect</span>
                </button>
                <button id="sendHeartbeatBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium mt-6 flex items-center space-x-2">
                    <span class="material-icons">favorite</span>
                    <span>Send Heartbeat Notification</span>
                </button>
            </div>
        </div>
        
        <!-- About Page -->
        <div id="aboutPage" class="page hidden mt-6">
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-2">About</h2>
                <p class="text-gray-600">Progressive Web App for Real-time Notifications</p>
            </div>
            
            <div class="space-y-6">
                <div class="bg-white rounded-xl shadow-sm border p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <span class="material-icons mr-2">rocket_launch</span>
                        Features
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="flex items-center space-x-3">
                            <span class="material-icons text-green-500">check_circle</span>
                            <span class="text-gray-700">Real-time MQTT notifications</span>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span class="material-icons text-green-500">check_circle</span>
                            <span class="text-gray-700">Offline support</span>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span class="material-icons text-green-500">check_circle</span>
                            <span class="text-gray-700">Installable PWA</span>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span class="material-icons text-green-500">check_circle</span>
                            <span class="text-gray-700">Push notifications</span>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span class="material-icons text-green-500">check_circle</span>
                            <span class="text-gray-700">Mobile-first design</span>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span class="material-icons text-green-500">check_circle</span>
                            <span class="text-gray-700">Data persistence</span>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl shadow-sm border p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <span class="material-icons mr-2">info</span>
                        Technical Information
                    </h3>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Version:</span>
                            <span class="font-medium">2.1.0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Build Date:</span>
                            <span id="buildDate" class="font-medium">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Storage Used:</span>
                            <span id="storageInfo" class="font-medium">Calculating...</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">PWA Support:</span>
                            <span id="pwaSupport" class="font-medium">Checking...</span>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl shadow-sm border p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <span class="material-icons mr-2">install_mobile</span>
                        Installation Guide
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-medium text-gray-900 mb-2">📱 Mobile Devices</h4>
                            <p class="text-gray-600 text-sm">Open in your browser and tap "Add to Home Screen" from the browser menu.</p>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-900 mb-2">💻 Desktop</h4>
                            <p class="text-gray-600 text-sm">Click the install button in your browser's address bar or use the install banner.</p>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-900 mb-2">🪟 Windows</h4>
                            <p class="text-gray-600 text-sm">Install from Microsoft Edge for full system integration and window controls.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>
    
    <!-- Bottom Sheet for Mobile Actions (Hidden by default) -->
    <div id="actionSheet" class="fixed inset-x-0 bottom-0 bg-white rounded-t-2xl shadow-2xl border-t transform translate-y-full transition-transform duration-300 z-50 hidden">
        <div class="p-4">
            <div class="w-12 h-1 bg-gray-300 rounded-full mx-auto mb-4"></div>
            <div id="actionSheetContent" class="space-y-3">
                <!-- Dynamic content -->
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/5.7.0/mqtt.min.js"></script>
    
    <script>
        // App state
        let mqttClient = null;
        let notifications = [];
        let currentPage = 'live';
        let deferredPrompt = null;
        let mqttConfig = {
            broker: 'wss://broker.emqx.io:8084/mqtt',
            topic: 'notifications/joborders',
            responseTopic: 'responses/joborders',
            clientId: 'notification-viewer-' + Math.random().toString(16).substr(2, 8),
            username: '',
            password: ''
        };

        // ...existing code...

        // Heartbeat notification trigger
        document.addEventListener('DOMContentLoaded', () => {
            // ...existing code...
            const heartbeatBtn = document.getElementById('sendHeartbeatBtn');
            if (heartbeatBtn) {
                heartbeatBtn.addEventListener('click', async () => {
                    heartbeatBtn.disabled = true;
                    heartbeatBtn.textContent = 'Sending...';
                    try {
                        // Replace '/api/heartbeat' with your backend endpoint
                        const res = await fetch('/api/heartbeat', { method: 'POST' });
                        if (res.ok) {
                            showToast('Heartbeat notification sent!', 'success');
                        } else {
                            showToast('Failed to send heartbeat.', 'error');
                        }
                    } catch (err) {
                        showToast('Error sending heartbeat.', 'error');
                    }
                    heartbeatBtn.disabled = false;
                    heartbeatBtn.textContent = 'Send Heartbeat Notification';
                });
            }
            // ...existing code...
        });
        
        // Initialize app
        function init() {
            console.log('🚀 Initializing Morph Messaging...');
            
            loadMqttConfig();
            setupEventListeners();
            updateCounts();
            updateAboutInfo();
            loadSavedNotifications();
            
            // Register service worker first
            registerServiceWorker();
            
            // Delay MQTT connection slightly to ensure UI is ready
            setTimeout(() => {
                connectMqtt();
            }, 500);
            
            // Handle install prompt after service worker is ready
            setTimeout(setupInstallPrompt, 1000);
        }
        
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/service-worker.js', {
                    scope: '/'
                })
                .then(registration => {
                    console.log('✅ Service Worker registered:', registration);
                    checkForUpdates(registration);
                    
                    // Force update check
                    registration.update();
                    
                    // Listen for service worker updates
                    registration.addEventListener('updatefound', () => {
                        console.log('🔄 Service Worker update found');
                    });
                })
                .catch(error => {
                    console.error('❌ Service Worker registration failed:', error);
                });
            }
        }

        function setupInstallPrompt() {
            // Check PWA criteria
            checkPWACriteria();
            
            // Set up beforeinstallprompt listener
            window.addEventListener('beforeinstallprompt', handleInstallPrompt);
            
            // Check if already installed
            if (window.matchMedia('(display-mode: standalone)').matches || 
                window.navigator.standalone === true) {
                console.log('📱 App already installed');
                return;
            }
            
            // Show install banner if criteria met and not dismissed recently
            setTimeout(checkInstallAvailability, 2000);
        }
        
        function handleInstallPrompt(e) {
            console.log('📱 Install prompt triggered');
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install banner
            showInstallBanner();
            
            // Log that the prompt is available
            console.log('📱 Install prompt stored, banner shown');
        }
        
        function checkPWACriteria() {
            const criteria = {
                serviceWorker: 'serviceWorker' in navigator,
                manifest: document.querySelector('link[rel="manifest"]') !== null,
                https: location.protocol === 'https:' || location.hostname === 'localhost',
                icons: true, // Assuming icons are present
                startUrl: true // We have a start URL in manifest
            };
            
            console.log('🔍 PWA Criteria Check:', criteria);
            
            const allMet = Object.values(criteria).every(Boolean);
            console.log('✅ All PWA criteria met:', allMet);
            
            if (!allMet) {
                console.warn('⚠️ Some PWA criteria not met. Install button may not appear.');
            }
            
            return allMet;
        }
        
        // Debug function to check PWA installation status
        function debugPWAStatus() {
            const status = {
                isStandalone: window.matchMedia('(display-mode: standalone)').matches,
                isAppleStandalone: window.navigator.standalone === true,
                hasServiceWorker: 'serviceWorker' in navigator,
                hasManifest: document.querySelector('link[rel="manifest"]') !== null,
                isHTTPS: location.protocol === 'https:' || location.hostname === 'localhost',
                hasBeforeInstallPrompt: deferredPrompt !== null,
                userAgent: navigator.userAgent,
                displayMode: window.matchMedia('(display-mode: standalone)').matches ? 'standalone' : 'browser'
            };
            
            console.group('🔍 PWA Installation Debug Status');
            console.table(status);
            console.groupEnd();
            
            // Show in UI for debugging
            if (currentPage === 'about') {
                const debugDiv = document.createElement('div');
                debugDiv.className = 'bg-yellow-50 border border-yellow-200 rounded-lg p-4 mt-4';
                debugDiv.innerHTML = `
                    <h4 class="font-semibold text-yellow-800 mb-2">🔍 PWA Debug Status</h4>
                    <div class="text-sm space-y-1">
                        ${Object.entries(status).map(([key, value]) => 
                            `<div><strong>${key}:</strong> ${value}</div>`
                        ).join('')}
                    </div>
                    <button onclick="this.parentElement.remove()" class="mt-2 text-yellow-600 hover:text-yellow-800 text-sm">
                        Close Debug Info
                    </button>
                `;
                
                const aboutContent = document.querySelector('#aboutPage .space-y-6');
                if (aboutContent) {
                    aboutContent.appendChild(debugDiv);
                }
            }
            
            return status;
        }
        
        // Add debug button to about page
        function addDebugButton() {
            const aboutPage = document.getElementById('aboutPage');
            if (aboutPage && !aboutPage.querySelector('.debug-button')) {
                const debugButton = document.createElement('button');
                debugButton.className = 'debug-button w-full bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg font-medium mt-4';
                debugButton.textContent = '🔍 Debug PWA Status';
                debugButton.onclick = debugPWAStatus;
                
                const lastSection = aboutPage.querySelector('.space-y-6 > div:last-child');
                if (lastSection) {
                    lastSection.appendChild(debugButton);
                }
            }
        }
        
        // Install prompt handling
        function checkInstallAvailability() {
            // Check if already installed
            if (window.matchMedia('(display-mode: standalone)').matches || 
                window.navigator.standalone === true) {
                console.log('📱 App already installed');
                return;
            }
            
            // Check if install was previously dismissed
            const dismissed = localStorage.getItem('installBannerDismissed');
            const dismissedTime = localStorage.getItem('installBannerDismissedTime');
            
            // Show again after 7 days
            if (dismissed && dismissedTime) {
                const daysSinceDismissed = (Date.now() - parseInt(dismissedTime)) / (1000 * 60 * 60 * 24);
                if (daysSinceDismissed < 7) {
                    console.log('📱 Install banner dismissed recently, not showing');
                    return;
                }
            }
            
            // Show install banner
            showInstallBanner();
        }
        
        function showInstallBanner() {
            const banner = document.getElementById('installBanner');
            banner.classList.remove('hidden');
            console.log('📱 Install banner shown');
        }
        
        function dismissInstallBanner() {
            const banner = document.getElementById('installBanner');
            banner.classList.add('hidden');
            localStorage.setItem('installBannerDismissed', 'true');
            localStorage.setItem('installBannerDismissedTime', Date.now().toString());
            console.log('📱 Install banner dismissed');
        }
        
        // PWA install handling
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('📱 Install prompt available');
            e.preventDefault();
            deferredPrompt = e;
            showInstallBanner();
        });
        
        // Navigation
        function showPage(page) {
            console.log('📄 Switching to page:', page);
            
            // Update navigation
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('text-blue-600', 'border-blue-600');
                btn.classList.add('text-gray-600', 'border-transparent');
            });
            
            const activeBtn = document.querySelector(`[data-page="${page}"]`);
            if (activeBtn) {
                activeBtn.classList.remove('text-gray-600', 'border-transparent');
                activeBtn.classList.add('text-blue-600', 'border-blue-600');
            }
            
            // Show page
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            const targetPage = document.getElementById(page + 'Page');
            if (targetPage) {
                targetPage.classList.remove('hidden');
                targetPage.classList.add('fade-in');
            }
            
            currentPage = page;
            
            // Page-specific actions
            if (page === 'history') {
                displayHistoryNotifications();
            } else if (page === 'about') {
                updateAboutInfo();
            }
        }
        
        // MQTT Configuration
        function loadMqttConfig() {
            const saved = localStorage.getItem('mqttConfig');
            if (saved) {
                try {
                    mqttConfig = { ...mqttConfig, ...JSON.parse(saved) };
                    updateConfigForm();
                    console.log('⚙️ MQTT config loaded from storage');
                } catch (error) {
                    console.error('❌ Error loading MQTT config:', error);
                }
            }
        }
        
        function updateConfigForm() {
            document.getElementById('mqttBroker').value = mqttConfig.broker || '';
            document.getElementById('mqttTopic').value = mqttConfig.topic || '';
            document.getElementById('mqttResponseTopic').value = mqttConfig.responseTopic || '';
            document.getElementById('mqttClientId').value = mqttConfig.clientId || '';
            document.getElementById('mqttUsername').value = mqttConfig.username || '';
            document.getElementById('mqttPassword').value = mqttConfig.password || '';
        }
        
        function saveMqttConfig() {
            mqttConfig = {
                broker: document.getElementById('mqttBroker').value || mqttConfig.broker,
                topic: document.getElementById('mqttTopic').value || mqttConfig.topic,
                responseTopic: document.getElementById('mqttResponseTopic').value || mqttConfig.responseTopic,
                clientId: document.getElementById('mqttClientId').value || mqttConfig.clientId,
                username: document.getElementById('mqttUsername').value || '',
                password: document.getElementById('mqttPassword').value || ''
            };
            
            localStorage.setItem('mqttConfig', JSON.stringify(mqttConfig));
            
            // Reconnect with new config
            if (mqttClient) {
                mqttClient.end();
                mqttClient = null;
            }
            
            setTimeout(connectMqtt, 500);
            showToast('Configuration saved! Reconnecting...', 'success');
        }
        
        // MQTT Connection
        function connectMqtt() {
            if (mqttClient && mqttClient.connected) {
                console.log('🔗 MQTT already connected');
                return;
            }
            
            try {
                console.log('🔗 Connecting to MQTT broker:', mqttConfig.broker);
                
                const options = {
                    clientId: mqttConfig.clientId,
                    clean: true,
                    connectTimeout: 4000,
                    reconnectPeriod: 1000
                };
                
                if (mqttConfig.username) {
                    options.username = mqttConfig.username;
                    options.password = mqttConfig.password;
                }
                
                mqttClient = mqtt.connect(mqttConfig.broker, options);
                
                mqttClient.on('connect', () => {
                    console.log('✅ MQTT Connected');
                    updateMqttStatus(true);
                    
                    // Subscribe to notification topic
                    mqttClient.subscribe(mqttConfig.topic, (err) => {
                        if (err) {
                            console.error('❌ MQTT Subscription failed:', err);
                            showToast('Failed to subscribe to topic', 'error');
                        } else {
                            console.log('📡 Subscribed to topic:', mqttConfig.topic);
                            showToast('Connected to MQTT broker!', 'success');
                        }
                    });
                });
                
                mqttClient.on('error', (error) => {
                    console.error('❌ MQTT Error:', error);
                    updateMqttStatus(false);
                    showToast('MQTT connection error', 'error');
                });
                
                mqttClient.on('close', () => {
                    console.log('🔌 MQTT Disconnected');
                    updateMqttStatus(false);
                });
                
                mqttClient.on('message', (topic, message) => {
                    console.log('📨 MQTT Message received:', topic);
                    handleIncomingNotification(topic, message.toString());
                });
                
            } catch (error) {
                console.error('❌ MQTT Connection failed:', error);
                updateMqttStatus(false);
                showToast('Failed to connect to MQTT broker', 'error');
            }
        }
        
        function updateMqttStatus(connected) {
            const statusElements = [
                { dot: document.getElementById('mqttStatusDot'), text: document.getElementById('mqttStatusText') },
                { dot: document.getElementById('connectionStatusDot'), text: document.getElementById('connectionStatus') }
            ];
            
            statusElements.forEach(({ dot, text }) => {
                if (dot && text) {
                    if (connected) {
                        dot.classList.remove('bg-red-500');
                        dot.classList.add('bg-green-500');
                        text.textContent = 'Connected';
                    } else {
                        dot.classList.remove('bg-green-500');
                        dot.classList.add('bg-red-500');
                        text.textContent = 'Disconnected';
                    }
                }
            });
        }
        
        // Notification handling
        function handleIncomingNotification(topic, message) {
            try {
                const notification = JSON.parse(message);
                
                // Add metadata
                notification.id = Date.now() + Math.random();
                notification.timestamp = new Date().toISOString();
                notification.status = notification.status || 'pending';
                
                // Add to notifications array
                notifications.unshift(notification);
                
                // Limit to 1000 notifications
                if (notifications.length > 1000) {
                    notifications = notifications.slice(0, 1000);
                }
                
                // Save to localStorage
                localStorage.setItem('notifications', JSON.stringify(notifications));
                
                // Update UI
                if (currentPage === 'live') {
                    displayLiveNotifications();
                }
                updateCounts();
                updateLastUpdated();
                
                // Show browser notification
                showBrowserNotification(notification);
                
                // Show toast
                showToast(`New notification: ${notification.title || 'Job Order'}`, 'info');
                
            } catch (error) {
                console.error('❌ Error parsing notification:', error);
                showToast('Received invalid notification format', 'error');
            }
        }
        
        function displayLiveNotifications() {
            const container = document.getElementById('liveNotifications');
            const recent = notifications.slice(0, 10);
            
            if (recent.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="material-icons text-gray-400 text-3xl">wifi_tethering</span>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">No notifications yet</h3>
                        <p class="text-gray-500">Waiting for incoming notifications from the MQTT broker...</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = recent.map(notification => createNotificationCard(notification)).join('');
        }
        
        function displayHistoryNotifications() {
            const container = document.getElementById('historyNotifications');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            
            let filtered = notifications.filter(n => {
                const matchesSearch = !searchTerm || 
                    n.title?.toLowerCase().includes(searchTerm) ||
                    n.content?.toLowerCase().includes(searchTerm) ||
                    n.jobOrderId?.toLowerCase().includes(searchTerm);
                
                const matchesStatus = !statusFilter || n.status === statusFilter;
                
                return matchesSearch && matchesStatus;
            });
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="material-icons text-gray-400 text-3xl">history</span>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">No notifications found</h3>
                        <p class="text-gray-500">Try adjusting your search or filter criteria</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filtered.map(notification => createNotificationCard(notification)).join('');
        }
        
        function createNotificationCard(notification) {
            const date = new Date(notification.timestamp);
            const timeAgo = getTimeAgo(date);
            const priorityColors = {
                'high': 'border-l-red-500 bg-red-50',
                'medium': 'border-l-yellow-500 bg-yellow-50',
                'low': 'border-l-blue-500 bg-blue-50'
            };
            const priorityClass = priorityColors[notification.priority?.toLowerCase()] || 'border-l-blue-500 bg-blue-50';
            
            const statusColors = {
                'pending': 'bg-yellow-100 text-yellow-800',
                'approved': 'bg-green-100 text-green-800',
                'rejected': 'bg-red-100 text-red-800'
            };
            const statusClass = statusColors[notification.status] || 'bg-gray-100 text-gray-800';
            
            return `
                <div class="bg-white rounded-xl shadow-sm border border-l-4 ${priorityClass} p-4 hover:shadow-md transition-shadow">
                    <div class="flex items-start justify-between mb-3">
                        <h3 class="text-lg font-semibold text-gray-900 flex-1 pr-2">
                            ${notification.title || 'Job Order Notification'}
                        </h3>
                        <span class="px-3 py-1 rounded-full text-xs font-medium ${statusClass}">
                            ${notification.status.toUpperCase()}
                        </span>
                    </div>
                    
                    <div class="flex flex-wrap gap-4 text-sm text-gray-600 mb-3">
                        <span class="flex items-center">
                            <span class="material-icons text-sm mr-1">confirmation_number</span>
                            Job: #${notification.jobOrderId || 'N/A'}
                        </span>
                        <span class="flex items-center">
                            <span class="material-icons text-sm mr-1">priority_high</span>
                            ${notification.priority || 'Normal'}
                        </span>
                        <span class="flex items-center">
                            <span class="material-icons text-sm mr-1">access_time</span>
                            ${timeAgo}
                        </span>
                    </div>
                    
                    <div class="text-gray-700 mb-4 line-clamp-3">
                        ${notification.content || notification.message || 'No content available'}
                    </div>
                    
                    <div class="flex flex-wrap gap-2">
                        ${notification.status === 'pending' ? `
                            <button onclick="respondToNotification('${notification.id}', 'approved')" 
                                class="flex items-center space-x-2 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors touch-target">
                                <span class="material-icons text-sm">check</span>
                                <span>Approve</span>
                            </button>
                            <button onclick="respondToNotification('${notification.id}', 'rejected')" 
                                class="flex items-center space-x-2 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors touch-target">
                                <span class="material-icons text-sm">close</span>
                                <span>Reject</span>
                            </button>
                        ` : ''}
                        <button onclick="viewNotificationDetails('${notification.id}')" 
                            class="flex items-center space-x-2 bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium transition-colors touch-target">
                            <span class="material-icons text-sm">visibility</span>
                            <span>Details</span>
                        </button>
                    </div>
                </div>
            `;
        }
        
        function respondToNotification(notificationId, action) {
            const notification = notifications.find(n => n.id == notificationId);
            if (!notification) return;
            
            // Update notification status
            notification.status = action;
            notification.respondedAt = new Date().toISOString();
            
            // Send response via MQTT
            if (mqttClient && mqttClient.connected) {
                const response = {
                    notificationId: notificationId,
                    jobOrderId: notification.jobOrderId,
                    action: action,
                    timestamp: new Date().toISOString(),
                    respondedBy: 'notification-viewer'
                };
                
                mqttClient.publish(mqttConfig.responseTopic, JSON.stringify(response));
            }
            
            // Update localStorage
            localStorage.setItem('notifications', JSON.stringify(notifications));
            
            // Refresh current view
            if (currentPage === 'live') {
                displayLiveNotifications();
            } else if (currentPage === 'history') {
                displayHistoryNotifications();
            }
            
            updateCounts();
            showToast(`Job Order #${notification.jobOrderId} ${action}!`, 'success');
        }
        
        function viewNotificationDetails(notificationId) {
            const notification = notifications.find(n => n.id == notificationId);
            if (!notification) return;
            
            // For mobile, show in bottom sheet
            if (window.innerWidth < 768) {
                showActionSheet(notification);
            } else {
                // For desktop, show in alert (could be replaced with modal)
                const details = `
Job Order Details:
━━━━━━━━━━━━━━━━━━━━━━━━
🎫 ID: #${notification.jobOrderId || 'N/A'}
📝 Title: ${notification.title || 'N/A'}
📊 Status: ${notification.status}
⚡ Priority: ${notification.priority || 'Normal'}
📥 Received: ${new Date(notification.timestamp).toLocaleString()}
${notification.respondedAt ? `✅ Responded: ${new Date(notification.respondedAt).toLocaleString()}` : ''}

📄 Content:
${notification.content || notification.message || 'No content available'}
                `;
                alert(details);
            }
        }
        
        function showActionSheet(notification) {
            const sheet = document.getElementById('actionSheet');
            const content = document.getElementById('actionSheetContent');
            
            content.innerHTML = `
                <div class="border-b pb-4 mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">${notification.title || 'Job Order Notification'}</h3>
                    <div class="flex items-center space-x-4 text-sm text-gray-600">
                        <span>Job: #${notification.jobOrderId || 'N/A'}</span>
                        <span>${notification.priority || 'Normal'} Priority</span>
                    </div>
                </div>
                <div class="text-gray-700 mb-4">
                    ${notification.content || notification.message || 'No content available'}
                </div>
                <div class="text-sm text-gray-500 mb-4">
                    Received: ${new Date(notification.timestamp).toLocaleString()}
                    ${notification.respondedAt ? `<br>Responded: ${new Date(notification.respondedAt).toLocaleString()}` : ''}
                </div>
                ${notification.status === 'pending' ? `
                    <div class="flex space-x-3 mb-4">
                        <button onclick="respondToNotification('${notification.id}', 'approved'); hideActionSheet()" 
                            class="flex-1 flex items-center justify-center space-x-2 bg-green-600 text-white py-3 rounded-lg font-medium">
                            <span class="material-icons">check</span>
                            <span>Approve</span>
                        </button>
                        <button onclick="respondToNotification('${notification.id}', 'rejected'); hideActionSheet()" 
                            class="flex-1 flex items-center justify-center space-x-2 bg-red-600 text-white py-3 rounded-lg font-medium">
                            <span class="material-icons">close</span>
                            <span>Reject</span>
                        </button>
                    </div>
                ` : ''}
                <button onclick="hideActionSheet()" 
                    class="w-full bg-gray-100 text-gray-700 py-3 rounded-lg font-medium">
                    Close
                </button>
            `;
            
            sheet.classList.remove('hidden');
            setTimeout(() => {
                sheet.style.transform = 'translateY(0)';
            }, 10);
        }
        
        function hideActionSheet() {
            const sheet = document.getElementById('actionSheet');
            sheet.style.transform = 'translateY(100%)';
            setTimeout(() => {
                sheet.classList.add('hidden');
            }, 300);
        }
        
        // Utility functions
        function updateCounts() {
            const total = notifications.length;
            const pending = notifications.filter(n => n.status === 'pending').length;
            
            document.getElementById('totalNotifications').textContent = total;
            document.getElementById('pendingCount').textContent = pending;
        }
        
        function updateLastUpdated() {
            const now = new Date();
            document.getElementById('lastUpdated').textContent = now.toLocaleTimeString();
        }
        
        function updateAboutInfo() {
            // Build date
            document.getElementById('buildDate').textContent = new Date().toLocaleDateString();
            
            // Storage info
            if ('storage' in navigator && 'estimate' in navigator.storage) {
                navigator.storage.estimate().then(estimate => {
                    const used = (estimate.usage / 1024 / 1024).toFixed(2);
                    const quota = (estimate.quota / 1024 / 1024 / 1024).toFixed(2);
                    document.getElementById('storageInfo').textContent = `${used} MB / ${quota} GB`;
                });
            } else {
                document.getElementById('storageInfo').textContent = 'Not available';
            }
            
            // PWA support
            const pwaFeatures = [];
            if ('serviceWorker' in navigator) pwaFeatures.push('Service Worker');
            if ('Notification' in window) pwaFeatures.push('Notifications');
            if ('storage' in navigator) pwaFeatures.push('Storage API');
            if (window.matchMedia('(display-mode: standalone)').matches) pwaFeatures.push('Standalone Mode');
            
            document.getElementById('pwaSupport').textContent = pwaFeatures.length > 0 ? pwaFeatures.join(', ') : 'Limited';
            
            // Add debug button
            addDebugButton();
        }
        
        function getTimeAgo(date) {
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) return 'Just now';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
            return `${Math.floor(diffInSeconds / 86400)}d ago`;
        }
        
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            
            const colors = {
                'success': 'bg-green-600',
                'error': 'bg-red-600',
                'info': 'bg-blue-600',
                'warning': 'bg-yellow-600'
            };
            
            const icons = {
                'success': 'check_circle',
                'error': 'error',
                'info': 'info',
                'warning': 'warning'
            };
            
            toast.className = `${colors[type]} text-white px-4 py-3 rounded-lg shadow-lg flex items-center space-x-3 max-w-sm slide-up`;
            toast.innerHTML = `
                <span class="material-icons">${icons[type]}</span>
                <span class="flex-1">${message}</span>
                <button onclick="this.parentElement.remove()" class="ml-2 p-1 hover:bg-white/20 rounded">
                    <span class="material-icons text-sm">close</span>
                </button>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.style.animation = 'slideUp 0.3s ease-out reverse';
                    setTimeout(() => toast.remove(), 300);
                }
            }, 4000);
        }
        
        function showBrowserNotification(notification) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(notification.title || 'New Job Order', {
                    body: `Job Order #${notification.jobOrderId || 'N/A'}: ${notification.content || notification.message || 'New notification'}`,
                    icon: 'icons/icon-192.png',
                    badge: 'icons/icon-192.png',
                    tag: `notification-${notification.id}`,
                    data: { notificationId: notification.id },
                    requireInteraction: notification.priority === 'high'
                });
            }
        }
        
        function checkForUpdates(registration) {
            registration.addEventListener('updatefound', () => {
                const newWorker = registration.installing;
                newWorker.addEventListener('statechange', () => {
                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                        showToast('App update available! Refresh to update.', 'info');
                    }
                });
            });
        }
        
        function loadSavedNotifications() {
            const saved = localStorage.getItem('notifications');
            if (saved) {
                try {
                    notifications = JSON.parse(saved);
                    updateCounts();
                    updateLastUpdated();
                    if (currentPage === 'live') {
                        displayLiveNotifications();
                    }
                    console.log('📂 Loaded', notifications.length, 'saved notifications');
                } catch (error) {
                    console.error('❌ Error loading saved notifications:', error);
                }
            }
        }
        
        // Event listeners
        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const page = btn.getAttribute('data-page');
                    showPage(page);
                });
            });
            
            // Install button
            document.getElementById('installButton').addEventListener('click', async () => {
                if (!deferredPrompt) {
                    showToast('Install not available. Try adding to home screen manually.', 'info');
                    return;
                }
                
                const result = await deferredPrompt.prompt();
                console.log('📱 Install prompt result:', result);
                
                if (result.outcome === 'accepted') {
                    showToast('App installation started!', 'success');
                    dismissInstallBanner();
                }
                
                deferredPrompt = null;
            });
            
            // Dismiss install banner
            document.getElementById('dismissBanner').addEventListener('click', dismissInstallBanner);
            
            // Search and filter
            document.getElementById('searchInput').addEventListener('input', displayHistoryNotifications);
            document.getElementById('statusFilter').addEventListener('change', displayHistoryNotifications);
            
            // Request notification permission
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        subscribeToPush();
                        showToast('Notifications enabled!', 'success');
                    }
                });
            }
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    switch (e.key) {
                        case '1':
                            e.preventDefault();
                            showPage('live');
                            break;
                        case '2':
                            e.preventDefault();
                            showPage('history');
                            break;
                        case '3':
                            e.preventDefault();
                            showPage('config');
                            break;
                        case '4':
                            e.preventDefault();
                            showPage('about');
                            break;
                    }
                }
            });
            
            // Handle PWA installation
            window.addEventListener('appinstalled', () => {
                dismissInstallBanner();
                showToast('App installed successfully!', 'success');
                console.log('✅ PWA was installed');
            });
            
            // Handle visibility change for better battery life
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    console.log('👁️ App hidden - reducing activity');
                } else {
                    console.log('👁️ App visible - resuming activity');
                    if (currentPage === 'live') {
                        displayLiveNotifications();
                    }
                    updateCounts();
                }
            });
            
            // Handle action sheet backdrop
            document.getElementById('actionSheet').addEventListener('click', (e) => {
                if (e.target.id === 'actionSheet') {
                    hideActionSheet();
                }
            });
            
            // Handle swipe gestures for mobile navigation
            let touchStartX = 0;
            let touchEndX = 0;
            
            document.addEventListener('touchstart', e => {
                touchStartX = e.changedTouches[0].screenX;
            });
            
            document.addEventListener('touchend', e => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            });
            
            function handleSwipe() {
                const swipeThreshold = 50;
                const diff = touchStartX - touchEndX;
                
                if (Math.abs(diff) > swipeThreshold) {
                    const pages = ['live', 'history', 'config', 'about'];
                    const currentIndex = pages.indexOf(currentPage);
                    
                    if (diff > 0 && currentIndex < pages.length - 1) {
                        // Swipe left - next page
                        showPage(pages[currentIndex + 1]);
                    } else if (diff < 0 && currentIndex > 0) {
                        // Swipe right - previous page
                        showPage(pages[currentIndex - 1]);
                    }
                }
            }
        }
        
        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🌟 DOM loaded, initializing app...');
            init();
        });
        
        // Global error handling
        window.addEventListener('error', (e) => {
            console.error('💥 Global error:', e.error);
            showToast('An error occurred. Please refresh the page.', 'error');
        });
        
        window.addEventListener('unhandledrejection', (e) => {
            console.error('💥 Unhandled promise rejection:', e.reason);
            showToast('An error occurred. Please refresh the page.', 'error');
        });
        
    </script>
</body>
</html>