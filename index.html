<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Morph Messaging</title>
    <meta name="description" content="Real-time Morph Messaging with MQTT integration">
    <meta name="theme-color" content="#2563EB">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Morph Messaging">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest.json">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Material Design Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', 'system-ui', 'sans-serif'],
                    },
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        /* Custom animations and overrides */
        .slide-up {
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .fade-in {
            animation: fadeIn 0.4s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .pulse-dot {
            animation: pulseDot 2s infinite;
        }
        
        @keyframes pulseDot {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }
        
        /* Status-specific card styling */
        .status-new {
            border-left: 4px solid #3b82f6;
            background: linear-gradient(135deg, #eff6ff 0%, #f8fafc 100%);
        }
        
        .status-pending {
            border-left: 4px solid #f59e0b;
            background: linear-gradient(135deg, #fef3c7 0%, #f8fafc 100%);
        }
        
        .status-approved {
            border-left: 4px solid #10b981;
            background: linear-gradient(135deg, #d1fae5 0%, #f8fafc 100%);
        }
        
        .status-rejected {
            border-left: 4px solid #ef4444;
            background: linear-gradient(135deg, #fee2e2 0%, #f8fafc 100%);
        }
        
        /* Priority indicators */
        .priority-high::before {
            content: '';
            position: absolute;
            top: 12px;
            right: 12px;
            width: 8px;
            height: 8px;
            background: #ef4444;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .priority-medium::before {
            content: '';
            position: absolute;
            top: 12px;
            right: 12px;
            width: 8px;
            height: 8px;
            background: #f59e0b;
            border-radius: 50%;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        /* Touch-friendly improvements */
        .touch-target {
            min-height: 44px;
            min-width: 44px;
        }
        
        /* Notification card hover effects */
        .notification-card {
            transition: all 0.2s ease;
        }
        
        .notification-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <!-- Install Banner -->
    <div id="installBanner" class="hidden bg-gradient-to-r from-blue-600 to-blue-700 text-white p-4 relative slide-up">
        <div class="flex items-center justify-between max-w-4xl mx-auto">
            <div class="flex items-center space-x-3">
                <span class="material-icons">get_app</span>
                <div>
                    <p class="font-medium">Install App</p>
                    <p class="text-blue-100 text-sm">Get the best experience with our PWA!</p>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <button id="installButton" class="bg-white/20 hover:bg-white/30 backdrop-blur border border-white/30 text-white px-4 py-2 rounded-lg font-medium transition-all duration-200 touch-target">
                    Install
                </button>
                <button id="dismissBanner" class="p-3 hover:bg-white/20 rounded-full transition-colors touch-target">
                    <span class="material-icons">close</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Header -->
    <header class="bg-white shadow-sm border-b sticky top-0 z-40">
        <div class="max-w-4xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center">
                        <span class="material-icons text-white text-xl">notifications</span>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold text-gray-900">Morph Messaging</h1>
                        <p class="text-sm text-gray-500 hidden sm:block">Real-time MQTT notifications</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="flex items-center space-x-2 bg-gray-50 px-3 py-2 rounded-lg">
                        <div id="mqttStatusDot" class="w-3 h-3 bg-red-500 rounded-full pulse-dot"></div>
                        <span id="mqttStatusText" class="text-sm font-medium text-gray-700">Disconnected</span>
                    </div>
                </div>
            </div>
        </div>
    </header>
    
    <!-- Navigation -->
    <nav class="bg-white border-b sticky top-16 z-30">
        <div class="max-w-4xl mx-auto">
            <div class="flex overflow-x-auto scrollbar-hide">
                <button class="nav-btn flex items-center space-x-2 px-4 py-3 text-blue-600 border-b-2 border-blue-600 whitespace-nowrap touch-target" data-page="live">
                    <span class="material-icons text-lg">wifi_tethering</span>
                    <span class="font-medium">Live</span>
                </button>
                <button class="nav-btn flex items-center space-x-2 px-4 py-3 text-gray-600 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-200 whitespace-nowrap touch-target" data-page="history">
                    <span class="material-icons text-lg">history</span>
                    <span class="font-medium">History</span>
                </button>
                <button class="nav-btn flex items-center space-x-2 px-4 py-3 text-gray-600 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-200 whitespace-nowrap touch-target" data-page="config">
                    <span class="material-icons text-lg">settings</span>
                    <span class="font-medium">Config</span>
                </button>
                <button class="nav-btn flex items-center space-x-2 px-4 py-3 text-gray-600 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-200 whitespace-nowrap touch-target" data-page="test">
                    <span class="material-icons text-lg">bug_report</span>
                    <span class="font-medium">Test</span>
                </button>
                <button class="nav-btn flex items-center space-x-2 px-4 py-3 text-gray-600 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-200 whitespace-nowrap touch-target" data-page="about">
                    <span class="material-icons text-lg">info</span>
                    <span class="font-medium">About</span>
                </button>
            </div>
        </div>
    </nav>
    
    <!-- Status Bar -->
    <div class="bg-white mx-4 mt-4 rounded-xl shadow-sm border p-4">
        <div class="grid grid-cols-2 lg:grid-cols-5 gap-4">
            <div class="text-center">
                <div class="flex items-center justify-center space-x-2 mb-1">
                    <div id="connectionStatusDot" class="w-3 h-3 bg-red-500 rounded-full pulse-dot"></div>
                    <span class="text-sm font-medium text-gray-600">Connection</span>
                </div>
                <p id="connectionStatus" class="text-lg font-bold text-gray-900">Disconnected</p>
            </div>
            <div class="text-center">
                <div class="flex items-center justify-center space-x-2 mb-1">
                    <span class="material-icons text-gray-500 text-sm">notifications</span>
                    <span class="text-sm font-medium text-gray-600">Total</span>
                </div>
                <p id="totalNotifications" class="text-lg font-bold text-blue-600">0</p>
            </div>
            <div class="text-center">
                <div class="flex items-center justify-center space-x-2 mb-1">
                    <span class="material-icons text-gray-500 text-sm">pending</span>
                    <span class="text-sm font-medium text-gray-600">Pending</span>
                </div>
                <p id="pendingCount" class="text-lg font-bold text-orange-600">0</p>
            </div>
            <div class="text-center">
                <div class="flex items-center justify-center space-x-2 mb-1">
                    <span class="material-icons text-gray-500 text-sm">check_circle</span>
                    <span class="text-sm font-medium text-gray-600">Approved</span>
                </div>
                <p id="approvedCount" class="text-lg font-bold text-green-600">0</p>
            </div>
            <div class="text-center">
                <div class="flex items-center justify-center space-x-2 mb-1">
                    <span class="material-icons text-gray-500 text-sm">access_time</span>
                    <span class="text-sm font-medium text-gray-600">Updated</span>
                </div>
                <p id="lastUpdated" class="text-sm font-medium text-gray-700">Never</p>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <main class="max-w-4xl mx-auto px-4 pb-6">
        <!-- Live Notifications Page -->
        <div id="livePage" class="page active mt-6">
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-2">Live Notifications</h2>
                <p class="text-gray-600">Real-time job order notifications from MQTT broker</p>
            </div>
            <div id="liveNotifications" class="space-y-4">
                <div class="text-center py-12">
                    <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <span class="material-icons text-gray-400 text-3xl">wifi_tethering</span>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">No notifications yet</h3>
                    <p class="text-gray-500">Waiting for incoming notifications from the MQTT broker...</p>
                </div>
            </div>
        </div>
        
        <!-- History Page -->
        <div id="historyPage" class="page hidden mt-6">
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-2">Notification History</h2>
                <p class="text-gray-600">Browse and search through past notifications</p>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border p-4 mb-6">
                <div class="flex flex-col sm:flex-row gap-4">
                    <div class="flex-1">
                        <div class="relative">
                            <span class="material-icons absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">search</span>
                            <input id="searchInput" type="text" placeholder="Search notifications..." 
                                class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>
                    <div class="sm:w-48">
                        <select id="statusFilter" class="w-full py-3 px-4 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">All Status</option>
                            <option value="new">New</option>
                            <option value="pending">Pending</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div id="historyNotifications" class="space-y-4">
                <div class="text-center py-12">
                    <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <span class="material-icons text-gray-400 text-3xl">history</span>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">No history yet</h3>
                    <p class="text-gray-500">Notification history will appear here once you start receiving notifications</p>
                </div>
            </div>
        </div>
        
        <!-- Configuration Page -->
        <div id="configPage" class="page hidden mt-6">
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-2">MQTT Configuration</h2>
                <p class="text-gray-600">Configure your MQTT broker connection settings</p>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">MQTT Broker URL</label>
                        <input id="mqttBroker" type="text" placeholder="wss://broker.emqx.io:8084/mqtt" 
                            class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Topic</label>
                        <input id="mqttTopic" type="text" placeholder="notifications/joborders" 
                            class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Client ID</label>
                        <input id="mqttClientId" type="text" placeholder="notification-viewer-001" 
                            class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Response Topic</label>
                        <input id="mqttResponseTopic" type="text" placeholder="responses/joborders" 
                            class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Username (Optional)</label>
                        <input id="mqttUsername" type="text" placeholder="username" 
                            class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password (Optional)</label>
                        <input id="mqttPassword" type="password" placeholder="password" 
                            class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>
                <button onclick="saveMqttConfig()" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors flex items-center justify-center space-x-2 touch-target">
                    <span class="material-icons">save</span>
                    <span>Save & Connect</span>
                </button>
            </div>
        </div>
        
        <!-- Test Page -->
        <div id="testPage" class="page hidden mt-6">
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-2">Push Notification Tester</h2>
                <p class="text-gray-600">Test push notifications and simulate different scenarios</p>
            </div>
            
            <!-- Push Notification Status -->
            <div class="bg-white rounded-xl shadow-sm border p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Push Notification Status</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="text-center">
                        <div id="pushPermissionStatus" class="w-16 h-16 rounded-full mx-auto mb-2 flex items-center justify-center bg-red-100">
                            <span class="material-icons text-red-600">notifications_off</span>
                        </div>
                        <p class="text-sm font-medium text-gray-700">Permission</p>
                        <p id="pushPermissionText" class="text-xs text-gray-500">Denied</p>
                    </div>
                    <div class="text-center">
                        <div id="pushServiceWorkerStatus" class="w-16 h-16 rounded-full mx-auto mb-2 flex items-center justify-center bg-red-100">
                            <span class="material-icons text-red-600">build</span>
                        </div>
                        <p class="text-sm font-medium text-gray-700">Service Worker</p>
                        <p id="pushServiceWorkerText" class="text-xs text-gray-500">Not Ready</p>
                    </div>
                    <div class="text-center">
                        <div id="pushSubscriptionStatus" class="w-16 h-16 rounded-full mx-auto mb-2 flex items-center justify-center bg-red-100">
                            <span class="material-icons text-red-600">link_off</span>
                        </div>
                        <p class="text-sm font-medium text-gray-700">Subscription</p>
                        <p id="pushSubscriptionText" class="text-xs text-gray-500">Not Subscribed</p>
                    </div>
                </div>
                <div class="flex flex-wrap gap-3">
                    <button id="requestPermissionBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium flex items-center space-x-2">
                        <span class="material-icons">notifications</span>
                        <span>Request Permission</span>
                    </button>
                    <button id="subscribePushBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium flex items-center space-x-2" disabled>
                        <span class="material-icons">link</span>
                        <span>Subscribe to Push</span>
                    </button>
                    <button id="unsubscribePushBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium flex items-center space-x-2" disabled>
                        <span class="material-icons">link_off</span>
                        <span>Unsubscribe</span>
                    </button>
                </div>
            </div>
            
            <!-- Test Notifications -->
            <div class="bg-white rounded-xl shadow-sm border p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Test Notifications</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <button onclick="testMockNotification('new')" class="p-4 border-2 border-blue-200 rounded-lg hover:border-blue-400 transition-colors text-left">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                <span class="material-icons text-blue-600">fiber_new</span>
                            </div>
                            <div>
                                <p class="font-medium text-gray-900">New Job Order</p>
                                <p class="text-sm text-gray-500">Simulate new notification</p>
                            </div>
                        </div>
                    </button>
                    
                    <button onclick="testMockNotification('pending')" class="p-4 border-2 border-yellow-200 rounded-lg hover:border-yellow-400 transition-colors text-left">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-yellow-100 rounded-full flex items-center justify-center">
                                <span class="material-icons text-yellow-600">pending</span>
                            </div>
                            <div>
                                <p class="font-medium text-gray-900">Pending Review</p>
                                <p class="text-sm text-gray-500">Simulate pending notification</p>
                            </div>
                        </div>
                    </button>
                    
                    <button onclick="testMockNotification('approved')" class="p-4 border-2 border-green-200 rounded-lg hover:border-green-400 transition-colors text-left">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                                <span class="material-icons text-green-600">check_circle</span>
                            </div>
                            <div>
                                <p class="font-medium text-gray-900">Approved</p>
                                <p class="text-sm text-gray-500">Simulate approved notification</p>
                            </div>
                        </div>
                    </button>
                    
                    <button onclick="testMockNotification('rejected')" class="p-4 border-2 border-red-200 rounded-lg hover:border-red-400 transition-colors text-left">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center">
                                <span class="material-icons text-red-600">cancel</span>
                            </div>
                            <div>
                                <p class="font-medium text-gray-900">Rejected</p>
                                <p class="text-sm text-gray-500">Simulate rejected notification</p>
                            </div>
                        </div>
                    </button>
                </div>
                
                <button id="sendHeartbeatBtn" class="w-full bg-purple-600 hover:bg-purple-700 text-white px-4 py-3 rounded-lg font-medium flex items-center justify-center space-x-2">
                    <span class="material-icons">favorite</span>
                    <span>Send Heartbeat Push Notification</span>
                </button>
            </div>
            
            <!-- VAPID Info -->
            <div class="bg-white rounded-xl shadow-sm border p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">VAPID Configuration</h3>
                <div class="bg-gray-50 rounded-lg p-4">
                    <p class="text-sm text-gray-600 mb-2">Public Key:</p>
                    <code class="text-xs bg-white p-2 rounded border block break-all">BGAq623vEDEL-ISsEZZRJyBVOssH6iVUmil3S0R3pr6qBTKq_3S5FFr99Plg9DIF8268XLbW0ss0RzK00afmTXA</code>
                </div>
                <div id="subscriptionInfo" class="mt-4 hidden">
                    <p class="text-sm text-gray-600 mb-2">Current Subscription:</p>
                    <textarea id="subscriptionDisplay" class="w-full h-32 text-xs bg-gray-50 p-3 rounded border" readonly></textarea>
                </div>
            </div>
        </div>
        
        <!-- About Page -->
        <div id="aboutPage" class="page hidden mt-6">
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-2">About</h2>
                <p class="text-gray-600">Progressive Web App for Real-time Notifications</p>
            </div>
            
            <div class="space-y-6">
                <div class="bg-white rounded-xl shadow-sm border p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <span class="material-icons mr-2">rocket_launch</span>
                        Features
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="flex items-center space-x-3">
                            <span class="material-icons text-green-500">check_circle</span>
                            <span class="text-gray-700">Data persistence</span>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span class="material-icons text-green-500">check_circle</span>
                            <span class="text-gray-700">Real-time MQTT notifications</span>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span class="material-icons text-green-500">check_circle</span>
                            <span class="text-gray-700">Offline support</span>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span class="material-icons text-green-500">check_circle</span>
                            <span class="text-gray-700">Installable PWA</span>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span class="material-icons text-green-500">check_circle</span>
                            <span class="text-gray-700">Push notifications</span>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span class="material-icons text-green-500">check_circle</span>
                            <span class="text-gray-700">Mobile-first design</span>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span class="material-icons text-green-500">check_circle</span>
                            <span class="text-gray-700">Data persistence</span>
                        </div>
                    </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl shadow-sm border p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <span class="material-icons mr-2">info</span>
                        Technical Information
                    </h3>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Version:</span>
                            <span class="font-medium">2.2.0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Build Date:</span>
                            <span id="buildDate" class="font-medium">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Storage Used:</span>
                            <span id="storageInfo" class="font-medium">Calculating...</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">PWA Support:</span>
                            <span id="pwaSupport" class="font-medium">Checking...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>
    
    <!-- Bottom Sheet for Mobile Actions -->
    <div id="actionSheet" class="fixed inset-x-0 bottom-0 bg-white rounded-t-2xl shadow-2xl border-t transform translate-y-full transition-transform duration-300 z-50 hidden">
        <div class="p-4">
            <div class="w-12 h-1 bg-gray-300 rounded-full mx-auto mb-4"></div>
            <div id="actionSheetContent" class="space-y-3">
                <!-- Dynamic content -->
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/5.7.0/mqtt.min.js"></script>
    
    <script>
        // App state
        let mqttClient = null;
        let notifications = [];
        let currentPage = 'live';
        let deferredPrompt = null;
        let pushSubscription = null;
        let mqttConfig = {
            broker: 'wss://broker.emqx.io:8084/mqtt',
            topic: 'notifications/joborders',
            responseTopic: 'responses/joborders',
            clientId: 'notification-viewer-' + Math.random().toString(16).substr(2, 8),
            username: '',
            password: ''
        };

        // VAPID public key for push notifications
        const VAPID_PUBLIC_KEY = 'BGAq623vEDEL-ISsEZZRJyBVOssH6iVUmil3S0R3pr6qBTKq_3S5FFr99Plg9DIF8268XLbW0ss0RzK00afmTXA';
        
        // Initialize app
        function init() {
            console.log('üöÄ Initializing Morph Messaging...');
            
            loadMqttConfig();
            setupEventListeners();
            updateCounts();
            updateAboutInfo();
            loadSavedNotifications();
            
            // Register service worker first
            registerServiceWorker();
            
            // Setup push notifications
            checkPushNotificationStatus();
            
            // Delay MQTT connection slightly to ensure UI is ready
            setTimeout(() => {
                connectMqtt();
            }, 500);
            
            // Handle install prompt after service worker is ready
            setTimeout(setupInstallPrompt, 1000);
        }
        
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/service-worker.js', {
                    scope: '/'
                })
                .then(registration => {
                    console.log('‚úÖ Service Worker registered:', registration);
                    checkForUpdates(registration);
                    
                    // Force update check
                    registration.update();
                    
                    // Listen for service worker updates
                    registration.addEventListener('updatefound', () => {
                        console.log('üîÑ Service Worker update found');
                    });
                })
                .catch(error => {
                    console.error('‚ùå Service Worker registration failed:', error);
                });
            }
        }

        // Push Notification Functions
        async function checkPushNotificationStatus() {
            updatePushStatus();
            
            if (!('serviceWorker' in navigator)) {
                console.warn('Service Worker not supported');
                return;
            }
            
            if (!('PushManager' in window)) {
                console.warn('Push messaging not supported');
                return;
            }
            
            try {
                const registration = await navigator.serviceWorker.ready;
                const subscription = await registration.pushManager.getSubscription();
                
                if (subscription) {
                    pushSubscription = subscription;
                    console.log('üì± Existing push subscription found');
                    
                    // Send subscription to server
                    await sendSubscriptionToServer(subscription);
                }
                
                updatePushStatus();
            } catch (error) {
                console.error('‚ùå Error checking push subscription:', error);
            }
        }
        
        function updatePushStatus() {
            // Permission status
            const permissionStatus = Notification.permission;
            const permissionElement = document.getElementById('pushPermissionStatus');
            const permissionText = document.getElementById('pushPermissionText');
            
            if (permissionStatus === 'granted') {
                permissionElement.className = 'w-16 h-16 rounded-full mx-auto mb-2 flex items-center justify-center bg-green-100';
                permissionElement.innerHTML = '<span class="material-icons text-green-600">notifications</span>';
                permissionText.textContent = 'Granted';
            } else if (permissionStatus === 'denied') {
                permissionElement.className = 'w-16 h-16 rounded-full mx-auto mb-2 flex items-center justify-center bg-red-100';
                permissionElement.innerHTML = '<span class="material-icons text-red-600">notifications_off</span>';
                permissionText.textContent = 'Denied';
            } else {
                permissionElement.className = 'w-16 h-16 rounded-full mx-auto mb-2 flex items-center justify-center bg-yellow-100';
                permissionElement.innerHTML = '<span class="material-icons text-yellow-600">notifications_none</span>';
                permissionText.textContent = 'Default';
            }
            
            // Service Worker status
            const swStatus = document.getElementById('pushServiceWorkerStatus');
            const swText = document.getElementById('pushServiceWorkerText');
            
            if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                swStatus.className = 'w-16 h-16 rounded-full mx-auto mb-2 flex items-center justify-center bg-green-100';
                swStatus.innerHTML = '<span class="material-icons text-green-600">build</span>';
                swText.textContent = 'Ready';
            } else {
                swStatus.className = 'w-16 h-16 rounded-full mx-auto mb-2 flex items-center justify-center bg-red-100';
                swStatus.innerHTML = '<span class="material-icons text-red-600">build</span>';
                swText.textContent = 'Not Ready';
            }
            
            // Subscription status
            const subStatus = document.getElementById('pushSubscriptionStatus');
            const subText = document.getElementById('pushSubscriptionText');
            
            if (pushSubscription) {
                subStatus.className = 'w-16 h-16 rounded-full mx-auto mb-2 flex items-center justify-center bg-green-100';
                subStatus.innerHTML = '<span class="material-icons text-green-600">link</span>';
                subText.textContent = 'Subscribed';
                
                // Show subscription details
                document.getElementById('subscriptionInfo').classList.remove('hidden');
                document.getElementById('subscriptionDisplay').value = JSON.stringify(pushSubscription, null, 2);
            } else {
                subStatus.className = 'w-16 h-16 rounded-full mx-auto mb-2 flex items-center justify-center bg-red-100';
                subStatus.innerHTML = '<span class="material-icons text-red-600">link_off</span>';
                subText.textContent = 'Not Subscribed';
                
                document.getElementById('subscriptionInfo').classList.add('hidden');
            }
            
            // Update button states
            const requestBtn = document.getElementById('requestPermissionBtn');
            const subscribeBtn = document.getElementById('subscribePushBtn');
            const unsubscribeBtn = document.getElementById('unsubscribePushBtn');
            
            requestBtn.disabled = permissionStatus === 'granted';
            subscribeBtn.disabled = !(permissionStatus === 'granted' && !pushSubscription);
            unsubscribeBtn.disabled = !pushSubscription;
        }
        
        async function requestNotificationPermission() {
            if (!('Notification' in window)) {
                showToast('Notifications not supported in this browser', 'error');
                return;
            }
            
            try {
                const permission = await Notification.requestPermission();
                
                if (permission === 'granted') {
                    showToast('Notification permission granted!', 'success');
                } else {
                    showToast('Notification permission denied', 'error');
                }
                
                updatePushStatus();
            } catch (error) {
                console.error('‚ùå Error requesting permission:', error);
                showToast('Error requesting permission', 'error');
            }
        }
        
        async function subscribeToPush() {
            if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
                showToast('Push notifications not supported', 'error');
                return;
            }
            
            if (Notification.permission !== 'granted') {
                showToast('Please grant notification permission first', 'error');
                return;
            }
            
            try {
                const registration = await navigator.serviceWorker.ready;
                
                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
                });
                
                pushSubscription = subscription;
                console.log('üì± Push subscription created:', subscription);
                
                // Send subscription to server
                await sendSubscriptionToServer(subscription);
                
                updatePushStatus();
                showToast('Successfully subscribed to push notifications!', 'success');
                
            } catch (error) {
                console.error('‚ùå Push subscription failed:', error);
                showToast('Failed to subscribe to push notifications', 'error');
            }
        }
        
        async function unsubscribeFromPush() {
            if (!pushSubscription) {
                showToast('No active subscription found', 'error');
                return;
            }
            
            try {
                await pushSubscription.unsubscribe();
                pushSubscription = null;
                
                updatePushStatus();
                showToast('Successfully unsubscribed from push notifications', 'success');
                
            } catch (error) {
                console.error('‚ùå Push unsubscription failed:', error);
                showToast('Failed to unsubscribe from push notifications', 'error');
            }
        }
        
        async function sendSubscriptionToServer(subscription) {
            try {
                const response = await fetch('/api/subscribe', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(subscription)
                });
                
                if (response.ok) {
                    console.log('‚úÖ Subscription sent to server');
                } else {
                    console.warn('‚ö†Ô∏è Failed to send subscription to server');
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Could not send subscription to server:', error);
                // Don't show error to user as this might be expected in development
            }
        }
        
        async function sendHeartbeat() {
            const btn = document.getElementById('sendHeartbeatBtn');
            const originalText = btn.innerHTML;
            
            btn.disabled = true;
            btn.innerHTML = '<span class="material-icons animate-pulse">favorite</span><span>Sending...</span>';
            
            try {
                const response = await fetch('/api/heartbeat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    showToast('Heartbeat notification sent!', 'success');
                } else {
                    showToast('Failed to send heartbeat notification', 'error');
                }
            } catch (error) {
                console.error('‚ùå Heartbeat error:', error);
                showToast('Error sending heartbeat notification', 'error');
            }
            
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
        
        // Test mock notifications
        function testMockNotification(status) {
            const mockNotifications = {
                new: {
                    title: 'New Job Order Received',
                    content: 'A new job order #JO-2024-001 has been submitted and requires your attention.',
                    jobOrderId: 'JO-2024-001',
                    priority: 'high',
                    status: 'new'
                },
                pending: {
                    title: 'Job Order Pending Review',
                    content: 'Job order #JO-2024-002 is awaiting your review and approval.',
                    jobOrderId: 'JO-2024-002',
                    priority: 'medium',
                    status: 'pending'
                },
                approved: {
                    title: 'Job Order Approved',
                    content: 'Job order #JO-2024-003 has been approved and is now active.',
                    jobOrderId: 'JO-2024-003',
                    priority: 'low',
                    status: 'approved'
                },
                rejected: {
                    title: 'Job Order Rejected',
                    content: 'Job order #JO-2024-004 has been rejected due to incomplete information.',
                    jobOrderId: 'JO-2024-004',
                    priority: 'medium',
                    status: 'rejected'
                }
            };
            
            const mockData = mockNotifications[status];
            if (mockData) {
                // Simulate MQTT message
                const message = JSON.stringify(mockData);
                handleIncomingNotification('test/topic', message);
                
                showToast(`Test ${status} notification created!`, 'success');
            }
        }
        
        // Utility function to convert VAPID key
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
                .replace(/-/g, '+')
                .replace(/_/g, '/');
            
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        // Navigation
        function showPage(page) {
            console.log('üìÑ Switching to page:', page);
            
            // Update navigation
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('text-blue-600', 'border-blue-600');
                btn.classList.add('text-gray-600', 'border-transparent');
            });
            
            const activeBtn = document.querySelector(`[data-page="${page}"]`);
            if (activeBtn) {
                activeBtn.classList.remove('text-gray-600', 'border-transparent');
                activeBtn.classList.add('text-blue-600', 'border-blue-600');
            }
            
            // Show page
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            const targetPage = document.getElementById(page + 'Page');
            if (targetPage) {
                targetPage.classList.remove('hidden');
                targetPage.classList.add('fade-in');
            }
            
            currentPage = page;
            
            // Page-specific actions
            if (page === 'history') {
                displayHistoryNotifications();
            } else if (page === 'about') {
                updateAboutInfo();
            } else if (page === 'test') {
                updatePushStatus();
            }
        }
        
        // MQTT Configuration
        function loadMqttConfig() {
            const saved = localStorage.getItem('mqttConfig');
            if (saved) {
                try {
                    mqttConfig = { ...mqttConfig, ...JSON.parse(saved) };
                    updateConfigForm();
                    console.log('‚öôÔ∏è MQTT config loaded from storage');
                } catch (error) {
                    console.error('‚ùå Error loading MQTT config:', error);
                }
            }
        }
        
        function updateConfigForm() {
            document.getElementById('mqttBroker').value = mqttConfig.broker || '';
            document.getElementById('mqttTopic').value = mqttConfig.topic || '';
            document.getElementById('mqttResponseTopic').value = mqttConfig.responseTopic || '';
            document.getElementById('mqttClientId').value = mqttConfig.clientId || '';
            document.getElementById('mqttUsername').value = mqttConfig.username || '';
            document.getElementById('mqttPassword').value = mqttConfig.password || '';
        }
        
        function saveMqttConfig() {
            mqttConfig = {
                broker: document.getElementById('mqttBroker').value || mqttConfig.broker,
                topic: document.getElementById('mqttTopic').value || mqttConfig.topic,
                responseTopic: document.getElementById('mqttResponseTopic').value || mqttConfig.responseTopic,
                clientId: document.getElementById('mqttClientId').value || mqttConfig.clientId,
                username: document.getElementById('mqttUsername').value || '',
                password: document.getElementById('mqttPassword').value || ''
            };
            
            localStorage.setItem('mqttConfig', JSON.stringify(mqttConfig));
            
            // Reconnect with new config
            if (mqttClient) {
                mqttClient.end();
                mqttClient = null;
            }
            
            setTimeout(connectMqtt, 500);
            showToast('Configuration saved! Reconnecting...', 'success');
        }
        
        // MQTT Connection
        function connectMqtt() {
            if (mqttClient && mqttClient.connected) {
                console.log('üîó MQTT already connected');
                return;
            }
            
            try {
                console.log('üîó Connecting to MQTT broker:', mqttConfig.broker);
                
                const options = {
                    clientId: mqttConfig.clientId,
                    clean: true,
                    connectTimeout: 4000,
                    reconnectPeriod: 1000
                };
                
                if (mqttConfig.username) {
                    options.username = mqttConfig.username;
                    options.password = mqttConfig.password;
                }
                
                mqttClient = mqtt.connect(mqttConfig.broker, options);
                
                mqttClient.on('connect', () => {
                    console.log('‚úÖ MQTT Connected');
                    updateMqttStatus(true);
                    
                    // Subscribe to notification topic
                    mqttClient.subscribe(mqttConfig.topic, (err) => {
                        if (err) {
                            console.error('‚ùå MQTT Subscription failed:', err);
                            showToast('Failed to subscribe to topic', 'error');
                        } else {
                            console.log('üì° Subscribed to topic:', mqttConfig.topic);
                            showToast('Connected to MQTT broker!', 'success');
                        }
                    });
                });
                
                mqttClient.on('error', (error) => {
                    console.error('‚ùå MQTT Error:', error);
                    updateMqttStatus(false);
                    showToast('MQTT connection error', 'error');
                });
                
                mqttClient.on('close', () => {
                    console.log('üîå MQTT Disconnected');
                    updateMqttStatus(false);
                });
                
                mqttClient.on('message', (topic, message) => {
                    console.log('üì® MQTT Message received:', topic);
                    handleIncomingNotification(topic, message.toString());
                });
                
            } catch (error) {
                console.error('‚ùå MQTT Connection failed:', error);
                updateMqttStatus(false);
                showToast('Failed to connect to MQTT broker', 'error');
            }
        }
        
        function updateMqttStatus(connected) {
            const statusElements = [
                { dot: document.getElementById('mqttStatusDot'), text: document.getElementById('mqttStatusText') },
                { dot: document.getElementById('connectionStatusDot'), text: document.getElementById('connectionStatus') }
            ];
            
            statusElements.forEach(({ dot, text }) => {
                if (dot && text) {
                    if (connected) {
                        dot.classList.remove('bg-red-500');
                        dot.classList.add('bg-green-500');
                        text.textContent = 'Connected';
                    } else {
                        dot.classList.remove('bg-green-500');
                        dot.classList.add('bg-red-500');
                        text.textContent = 'Disconnected';
                    }
                }
            });
        }
        
        // Notification handling
        function handleIncomingNotification(topic, message) {
            try {
                const notification = JSON.parse(message);
                
                // Add metadata
                notification.id = Date.now() + Math.random();
                notification.timestamp = new Date().toISOString();
                notification.status = notification.status || 'new';
                
                // Add to notifications array
                notifications.unshift(notification);
                
                // Limit to 1000 notifications
                if (notifications.length > 1000) {
                    notifications = notifications.slice(0, 1000);
                }
                
                // Save to localStorage
                localStorage.setItem('notifications', JSON.stringify(notifications));
                
                // Update UI
                if (currentPage === 'live') {
                    displayLiveNotifications();
                }
                updateCounts();
                updateLastUpdated();
                
                // Show browser notification
                showBrowserNotification(notification);
                
                // Show toast
                showToast(`New notification: ${notification.title || 'Job Order'}`, 'info');
                
            } catch (error) {
                console.error('‚ùå Error parsing notification:', error);
                showToast('Received invalid notification format', 'error');
            }
        }
        
        function displayLiveNotifications() {
            const container = document.getElementById('liveNotifications');
            const recent = notifications.slice(0, 10);
            
            if (recent.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="material-icons text-gray-400 text-3xl">wifi_tethering</span>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">No notifications yet</h3>
                        <p class="text-gray-500">Waiting for incoming notifications from the MQTT broker...</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = recent.map(notification => createNotificationCard(notification)).join('');
        }
        
        function displayHistoryNotifications() {
            const container = document.getElementById('historyNotifications');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            
            let filtered = notifications.filter(n => {
                const matchesSearch = !searchTerm || 
                    n.title?.toLowerCase().includes(searchTerm) ||
                    n.content?.toLowerCase().includes(searchTerm) ||
                    n.jobOrderId?.toLowerCase().includes(searchTerm);
                
                const matchesStatus = !statusFilter || n.status === statusFilter;
                
                return matchesSearch && matchesStatus;
            });
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="material-icons text-gray-400 text-3xl">history</span>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">No notifications found</h3>
                        <p class="text-gray-500">Try adjusting your search or filter criteria</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filtered.map(notification => createNotificationCard(notification)).join('');
        }
        
        function createNotificationCard(notification) {
            const date = new Date(notification.timestamp);
            const timeAgo = getTimeAgo(date);
            
            // Improved status-based styling
            const statusConfig = {
                'new': {
                    class: 'status-new',
                    badge: 'bg-blue-100 text-blue-800',
                    icon: 'fiber_new',
                    iconColor: 'text-blue-600'
                },
                'pending': {
                    class: 'status-pending',
                    badge: 'bg-yellow-100 text-yellow-800',
                    icon: 'pending',
                    iconColor: 'text-yellow-600'
                },
                'approved': {
                    class: 'status-approved',
                    badge: 'bg-green-100 text-green-800',
                    icon: 'check_circle',
                    iconColor: 'text-green-600'
                },
                'rejected': {
                    class: 'status-rejected',
                    badge: 'bg-red-100 text-red-800',
                    icon: 'cancel',
                    iconColor: 'text-red-600'
                }
            };
            
            const config = statusConfig[notification.status] || statusConfig['new'];
            
            // Priority class for visual indicator
            const priorityClass = notification.priority === 'high' ? 'priority-high' : 
                                 notification.priority === 'medium' ? 'priority-medium' : '';
            
            return `
                <div class="notification-card bg-white rounded-xl shadow-sm border ${config.class} ${priorityClass} p-4 relative">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center space-x-3 flex-1">
                            <div class="w-10 h-10 bg-gray-50 rounded-full flex items-center justify-center">
                                <span class="material-icons ${config.iconColor}">${config.icon}</span>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-900 flex-1">
                                ${notification.title || 'Job Order Notification'}
                            </h3>
                        </div>
                        <span class="px-3 py-1 rounded-full text-xs font-medium ${config.badge}">
                            ${notification.status.toUpperCase()}
                        </span>
                    </div>
                    
                    <div class="flex flex-wrap gap-4 text-sm text-gray-600 mb-3">
                        <span class="flex items-center">
                            <span class="material-icons text-sm mr-1">confirmation_number</span>
                            Job: #${notification.jobOrderId || 'N/A'}
                        </span>
                        <span class="flex items-center">
                            <span class="material-icons text-sm mr-1">priority_high</span>
                            ${notification.priority || 'Normal'}
                        </span>
                        <span class="flex items-center">
                            <span class="material-icons text-sm mr-1">access_time</span>
                            ${timeAgo}
                        </span>
                    </div>
                    
                    <div class="text-gray-700 mb-4 line-clamp-3">
                        ${notification.content || notification.message || 'No content available'}
                    </div>
                    
                    <div class="flex flex-wrap gap-2">
                        ${(notification.status === 'pending' || notification.status === 'new') ? `
                            <button onclick="respondToNotification('${notification.id}', 'approved')" 
                                class="flex items-center space-x-2 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors touch-target">
                                <span class="material-icons text-sm">check</span>
                                <span>Approve</span>
                            </button>
                            <button onclick="respondToNotification('${notification.id}', 'rejected')" 
                                class="flex items-center space-x-2 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors touch-target">
                                <span class="material-icons text-sm">close</span>
                                <span>Reject</span>
                            </button>
                        ` : ''}
                        <button onclick="viewNotificationDetails('${notification.id}')" 
                            class="flex items-center space-x-2 bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium transition-colors touch-target">
                            <span class="material-icons text-sm">visibility</span>
                            <span>Details</span>
                        </button>
                    </div>
                </div>
            `;
        }
        
        function respondToNotification(notificationId, action) {
            const notification = notifications.find(n => n.id == notificationId);
            if (!notification) return;
            
            // Update notification status
            notification.status = action;
            notification.respondedAt = new Date().toISOString();
            
            // Send response via MQTT
            if (mqttClient && mqttClient.connected) {
                const response = {
                    notificationId: notificationId,
                    jobOrderId: notification.jobOrderId,
                    action: action,
                    timestamp: new Date().toISOString(),
                    respondedBy: 'notification-viewer'
                };
                
                mqttClient.publish(mqttConfig.responseTopic, JSON.stringify(response));
            }
            
            // Update localStorage
            localStorage.setItem('notifications', JSON.stringify(notifications));
            
            // Refresh current view
            if (currentPage === 'live') {
                displayLiveNotifications();
            } else if (currentPage === 'history') {
                displayHistoryNotifications();
            }
            
            updateCounts();
            showToast(`Job Order #${notification.jobOrderId} ${action}!`, 'success');
        }
        
        function viewNotificationDetails(notificationId) {
            const notification = notifications.find(n => n.id == notificationId);
            if (!notification) return;
            
            // For mobile, show in bottom sheet
            if (window.innerWidth < 768) {
                showActionSheet(notification);
            } else {
                // For desktop, show in alert (could be replaced with modal)
                const details = `
Job Order Details:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üé´ ID: #${notification.jobOrderId || 'N/A'}
üìù Title: ${notification.title || 'N/A'}
üìä Status: ${notification.status}
‚ö° Priority: ${notification.priority || 'Normal'}
üì• Received: ${new Date(notification.timestamp).toLocaleString()}
${notification.respondedAt ? `‚úÖ Responded: ${new Date(notification.respondedAt).toLocaleString()}` : ''}

üìÑ Content:
${notification.content || notification.message || 'No content available'}
                `;
                alert(details);
            }
        }
        
        function showActionSheet(notification) {
            const sheet = document.getElementById('actionSheet');
            const content = document.getElementById('actionSheetContent');
            
            content.innerHTML = `
                <div class="border-b pb-4 mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">${notification.title || 'Job Order Notification'}</h3>
                    <div class="flex items-center space-x-4 text-sm text-gray-600">
                        <span>Job: #${notification.jobOrderId || 'N/A'}</span>
                        <span>${notification.priority || 'Normal'} Priority</span>
                    </div>
                </div>
                <div class="text-gray-700 mb-4">
                    ${notification.content || notification.message || 'No content available'}
                </div>
                <div class="text-sm text-gray-500 mb-4">
                    Received: ${new Date(notification.timestamp).toLocaleString()}
                    ${notification.respondedAt ? `<br>Responded: ${new Date(notification.respondedAt).toLocaleString()}` : ''}
                </div>
                ${(notification.status === 'pending' || notification.status === 'new') ? `
                    <div class="flex space-x-3 mb-4">
                        <button onclick="respondToNotification('${notification.id}', 'approved'); hideActionSheet()" 
                            class="flex-1 flex items-center justify-center space-x-2 bg-green-600 text-white py-3 rounded-lg font-medium">
                            <span class="material-icons">check</span>
                            <span>Approve</span>
                        </button>
                        <button onclick="respondToNotification('${notification.id}', 'rejected'); hideActionSheet()" 
                            class="flex-1 flex items-center justify-center space-x-2 bg-red-600 text-white py-3 rounded-lg font-medium">
                            <span class="material-icons">close</span>
                            <span>Reject</span>
                        </button>
                    </div>
                ` : ''}
                <button onclick="hideActionSheet()" 
                    class="w-full bg-gray-100 text-gray-700 py-3 rounded-lg font-medium">
                    Close
                </button>
            `;
            
            sheet.classList.remove('hidden');
            setTimeout(() => {
                sheet.style.transform = 'translateY(0)';
            }, 10);
        }
        
        function hideActionSheet() {
            const sheet = document.getElementById('actionSheet');
            sheet.style.transform = 'translateY(100%)';
            setTimeout(() => {
                sheet.classList.add('hidden');
            }, 300);
        }
        
        // Utility functions
        function updateCounts() {
            const total = notifications.length;
            const pending = notifications.filter(n => n.status === 'pending' || n.status === 'new').length;
            const approved = notifications.filter(n => n.status === 'approved').length;
            
            document.getElementById('totalNotifications').textContent = total;
            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('approvedCount').textContent = approved;
        }
        
        function updateLastUpdated() {
            const now = new Date();
            document.getElementById('lastUpdated').textContent = now.toLocaleTimeString();
        }
        
        function updateAboutInfo() {
            // Build date
            document.getElementById('buildDate').textContent = new Date().toLocaleDateString();
            
            // Storage info
            if ('storage' in navigator && 'estimate' in navigator.storage) {
                navigator.storage.estimate().then(estimate => {
                    const used = (estimate.usage / 1024 / 1024).toFixed(2);
                    const quota = (estimate.quota / 1024 / 1024 / 1024).toFixed(2);
                    document.getElementById('storageInfo').textContent = `${used} MB / ${quota} GB`;
                });
            } else {
                document.getElementById('storageInfo').textContent = 'Not available';
            }
            
            // PWA support
            const pwaFeatures = [];
            if ('serviceWorker' in navigator) pwaFeatures.push('Service Worker');
            if ('Notification' in window) pwaFeatures.push('Notifications');
            if ('storage' in navigator) pwaFeatures.push('Storage API');
            if (window.matchMedia('(display-mode: standalone)').matches) pwaFeatures.push('Standalone Mode');
            
            document.getElementById('pwaSupport').textContent = pwaFeatures.length > 0 ? pwaFeatures.join(', ') : 'Limited';
        }
        
        function getTimeAgo(date) {
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) return 'Just now';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
            return `${Math.floor(diffInSeconds / 86400)}d ago`;
        }
        
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            
            const colors = {
                'success': 'bg-green-600',
                'error': 'bg-red-600',
                'info': 'bg-blue-600',
                'warning': 'bg-yellow-600'
            };
            
            const icons = {
                'success': 'check_circle',
                'error': 'error',
                'info': 'info',
                'warning': 'warning'
            };
            
            toast.className = `${colors[type]} text-white px-4 py-3 rounded-lg shadow-lg flex items-center space-x-3 max-w-sm slide-up`;
            toast.innerHTML = `
                <span class="material-icons">${icons[type]}</span>
                <span class="flex-1">${message}</span>
                <button onclick="this.parentElement.remove()" class="ml-2 p-1 hover:bg-white/20 rounded">
                    <span class="material-icons text-sm">close</span>
                </button>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.style.animation = 'slideUp 0.3s ease-out reverse';
                    setTimeout(() => toast.remove(), 300);
                }
            }, 4000);
        }
        
        function showBrowserNotification(notification) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(notification.title || 'New Job Order', {
                    body: `Job Order #${notification.jobOrderId || 'N/A'}: ${notification.content || notification.message || 'New notification'}`,
                    icon: '/icons/android/android-launchericon-192-192.png',
                    badge: '/icons/android/android-launchericon-96-96.png',
                    tag: `notification-${notification.id}`,
                    data: { notificationId: notification.id },
                    requireInteraction: notification.priority === 'high'
                });
            }
        }
        
        function checkForUpdates(registration) {
            registration.addEventListener('updatefound', () => {
                const newWorker = registration.installing;
                newWorker.addEventListener('statechange', () => {
                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                        showToast('App update available! Refresh to update.', 'info');
                    }
                });
            });
        }
        
        function loadSavedNotifications() {
            const saved = localStorage.getItem('notifications');
            if (saved) {
                try {
                    notifications = JSON.parse(saved);
                    updateCounts();
                    updateLastUpdated();
                    if (currentPage === 'live') {
                        displayLiveNotifications();
                    }
                    console.log('üìÇ Loaded', notifications.length, 'saved notifications');
                } catch (error) {
                    console.error('‚ùå Error loading saved notifications:', error);
                }
            }
        }

        // Install prompt handling
        function setupInstallPrompt() {
            // Handle beforeinstallprompt
            window.addEventListener('beforeinstallprompt', (e) => {
                console.log('üì± Install prompt available');
                e.preventDefault();
                deferredPrompt = e;
                showInstallBanner();
            });
            
            // Check if already installed
            if (window.matchMedia('(display-mode: standalone)').matches || 
                window.navigator.standalone === true) {
                console.log('üì± App already installed');
                return;
            }
        }
        
        function showInstallBanner() {
            const banner = document.getElementById('installBanner');
            banner.classList.remove('hidden');
            console.log('üì± Install banner shown');
        }
        
        function dismissInstallBanner() {
            const banner = document.getElementById('installBanner');
            banner.classList.add('hidden');
            localStorage.setItem('installBannerDismissed', 'true');
            localStorage.setItem('installBannerDismissedTime', Date.now().toString());
            console.log('üì± Install banner dismissed');
        }
        
        // Event listeners
        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const page = btn.getAttribute('data-page');
                    showPage(page);
                });
            });
            
            // Install button
            document.getElementById('installButton').addEventListener('click', async () => {
                if (!deferredPrompt) {
                    showToast('Install not available. Try adding to home screen manually.', 'info');
                    return;
                }
                
                const result = await deferredPrompt.prompt();
                console.log('üì± Install prompt result:', result);
                
                if (result.outcome === 'accepted') {
                    showToast('App installation started!', 'success');
                    dismissInstallBanner();
                }
                
                deferredPrompt = null;
            });
            
            // Dismiss install banner
            document.getElementById('dismissBanner').addEventListener('click', dismissInstallBanner);
            
            // Search and filter
            document.getElementById('searchInput').addEventListener('input', displayHistoryNotifications);
            document.getElementById('statusFilter').addEventListener('change', displayHistoryNotifications);
            
            // Push notification buttons
            document.getElementById('requestPermissionBtn').addEventListener('click', requestNotificationPermission);
            document.getElementById('subscribePushBtn').addEventListener('click', subscribeToPush);
            document.getElementById('unsubscribePushBtn').addEventListener('click', unsubscribeFromPush);
            document.getElementById('sendHeartbeatBtn').addEventListener('click', sendHeartbeat);
            
            // Handle PWA installation
            window.addEventListener('appinstalled', () => {
                dismissInstallBanner();
                showToast('App installed successfully!', 'success');
                console.log('‚úÖ PWA was installed');
            });
            
            // Handle visibility change for better battery life
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    console.log('üëÅÔ∏è App hidden - reducing activity');
                } else {
                    console.log('üëÅÔ∏è App visible - resuming activity');
                    if (currentPage === 'live') {
                        displayLiveNotifications();
                    }
                    updateCounts();
                }
            });
            
            // Handle action sheet backdrop
            document.getElementById('actionSheet').addEventListener('click', (e) => {
                if (e.target.id === 'actionSheet') {
                    hideActionSheet();
                }
            });
            
            // Handle swipe gestures for mobile navigation
            let touchStartX = 0;
            let touchEndX = 0;
            
            document.addEventListener('touchstart', e => {
                touchStartX = e.changedTouches[0].screenX;
            });
            
            document.addEventListener('touchend', e => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            });
            
            function handleSwipe() {
                const swipeThreshold = 50;
                const diff = touchStartX - touchEndX;
                
                if (Math.abs(diff) > swipeThreshold) {
                    const pages = ['live', 'history', 'config', 'test', 'about'];
                    const currentIndex = pages.indexOf(currentPage);
                    
                    if (diff > 0 && currentIndex < pages.length - 1) {
                        // Swipe left - next page
                        showPage(pages[currentIndex + 1]);
                    } else if (diff < 0 && currentIndex > 0) {
                        // Swipe right - previous page
                        showPage(pages[currentIndex - 1]);
                    }
                }
            }
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    switch (e.key) {
                        case '1':
                            e.preventDefault();
                            showPage('live');
                            break;
                        case '2':
                            e.preventDefault();
                            showPage('history');
                            break;
                        case '3':
                            e.preventDefault();
                            showPage('config');
                            break;
                        case '4':
                            e.preventDefault();
                            showPage('test');
                            break;
                        case '5':
                            e.preventDefault();
                            showPage('about');
                            break;
                    }
                }
            });
        }
        
        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üåü DOM loaded, initializing app...');
            init();
        });
        
        // Global error handling
        window.addEventListener('error', (e) => {
            console.error('üí• Global error:', e.error);
            showToast('An error occurred. Please refresh the page.', 'error');
        });
        
        window.addEventListener('unhandledrejection', (e) => {
            console.error('üí• Unhandled promise rejection:', e.reason);
            showToast('An error occurred. Please refresh the page.', 'error');
        });
        
    </script>
</body>
</html>